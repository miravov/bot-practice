import logging
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes
import nltk
from nltk.chat.util import Chat, reflections
import os
from dotenv import load_dotenv

load_dotenv()

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)

# –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö NLTK
nltk.download('punkt')

# –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–æ–≤ –∏ –æ—Ç–≤–µ—Ç–æ–≤ –¥–ª—è —á–∞—Ç-–±–æ—Ç–∞
patterns = [
    (r'–ø—Ä–∏–≤–µ—Ç|–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π|—Ö–∞–π|—Ö–µ–ª–ª–æ|–¥–æ–±—Ä–æ–µ —É—Ç—Ä–æ|–¥–æ–±—Ä—ã–π –¥–µ–Ω—å|–¥–æ–±—Ä—ã–π –≤–µ—á–µ—Ä',
     ['–ü—Ä–∏–≤–µ—Ç! –†–∞–¥ –≤–∞—Å –≤–∏–¥–µ—Ç—å!', '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ö–∞–∫ —è –º–æ–≥—É –≤–∞–º –ø–æ–º–æ—á—å?', '–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é! –ß–µ–º –º–æ–≥—É –±—ã—Ç—å –ø–æ–ª–µ–∑–µ–Ω?']),
    
    (r'–∫–∞–∫ –¥–µ–ª–∞|–∫–∞–∫ —Ç—ã|–∫–∞–∫ –ø–æ–∂–∏–≤–∞–µ—à—å|–∫–∞–∫ —Ç–≤–æ–∏ –¥–µ–ª–∞',
     ['–û—Ç–ª–∏—á–Ω–æ! –ê —É –≤–∞—Å –∫–∞–∫ –¥–µ–ª–∞?', '–í—Å–µ —Ö–æ—Ä–æ—à–æ! –ö–∞–∫ –≤–∞—à–∏ –¥–µ–ª–∞?', '–ó–∞–º–µ—á–∞—Ç–µ–ª—å–Ω–æ! –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ, –∫–∞–∫ —É –≤–∞—Å –¥–µ–ª–∞?']),
    
    (r'—Ö–æ—Ä–æ—à–æ|–æ—Ç–ª–∏—á–Ω–æ|–∑–∞–º–µ—á–∞—Ç–µ–ª—å–Ω–æ|–ø—Ä–µ–∫—Ä–∞—Å–Ω–æ|—Å—É–ø–µ—Ä',
     ['–≠—Ç–æ –∑–¥–æ—Ä–æ–≤–æ! –†–∞–¥ –∑–∞ –≤–∞—Å!', '–†–∞–¥ —ç—Ç–æ —Å–ª—ã—à–∞—Ç—å! –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ!', '–û—á–µ–Ω—å –ø—Ä–∏—è—Ç–Ω–æ! –ñ–µ–ª–∞—é –≤–∞–º –¥–∞–ª—å–Ω–µ–π—à–∏—Ö —É—Å–ø–µ—Ö–æ–≤!']),
    
    (r'–ø–ª–æ—Ö–æ|—É–∂–∞—Å–Ω–æ|–Ω–µ –æ—á–µ–Ω—å|—Ç–∞–∫ —Å–µ–±–µ|–Ω–µ–≤–∞–∂–Ω–æ',
     ['–ù–µ –ø–µ—Ä–µ–∂–∏–≤–∞–π—Ç–µ, –≤—Å–µ –Ω–∞–ª–∞–¥–∏—Ç—Å—è!', '–ì–ª–∞–≤–Ω–æ–µ - –Ω–µ —Å–¥–∞–≤–∞—Ç—å—Å—è! –Ø –≤–µ—Ä—é –≤ –≤–∞—Å!', '–î–µ—Ä–∂–∏—Ç–µ—Å—å! –í—Å—ë –ø—Ä–æ–π–¥–µ—Ç, –∏ —Å–æ–ª–Ω—Ü–µ —Å–Ω–æ–≤–∞ –∑–∞—Å–∏—è–µ—Ç!']),
    
    (r'–ø–æ–∫–∞|–¥–æ —Å–≤–∏–¥–∞–Ω–∏—è|–¥–æ –≤—Å—Ç—Ä–µ—á–∏|–ø—Ä–æ—â–∞–π|–≤—Å–µ–≥–æ –¥–æ–±—Ä–æ–≥–æ',
     ['–î–æ —Å–≤–∏–¥–∞–Ω–∏—è! –ë—É–¥—É —Ä–∞–¥ –ø–æ–æ–±—â–∞—Ç—å—Å—è —Å–Ω–æ–≤–∞!', '–í—Å–µ–≥–æ –¥–æ–±—Ä–æ–≥–æ! –í–æ–∑–≤—Ä–∞—â–∞–π—Ç–µ—Å—å —Å–∫–æ—Ä–µ–µ!', '–î–æ –≤—Å—Ç—Ä–µ—á–∏! –•–æ—Ä–æ—à–µ–≥–æ –¥–Ω—è!']),
    
    (r'—Å–ø–∞—Å–∏–±–æ|–±–ª–∞–≥–æ–¥–∞—Ä—é|—Ç—ã –º–Ω–µ –ø–æ–º–æ–≥',
     ['–ü–æ–∂–∞–ª—É–π—Å—Ç–∞! –†–∞–¥ –±—ã–ª –ø–æ–º–æ—á—å!', '–û–±—Ä–∞—â–∞–π—Ç–µ—Å—å! –í—Å–µ–≥–¥–∞ –≥–æ—Ç–æ–≤ –ø–æ–º–æ—á—å!', '–ù–µ –∑–∞ —á—Ç–æ! –ë—É–¥—É —Ä–∞–¥ –ø–æ–º–æ—á—å —Å–Ω–æ–≤–∞!']),
    
    (r'–∫—Ç–æ —Ç—ã|—Ä–∞—Å—Å–∫–∞–∂–∏ –æ —Å–µ–±–µ|—á—Ç–æ —Ç—ã —É–º–µ–µ—à—å',
     ['–Ø –≤–∞—à –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫! –Ø –º–æ–≥—É –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å –±–µ—Å–µ–¥—É –∏ –ø–æ–º–æ—á—å –≤–∞–º –≤ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–∞—Ö.', 
      '–Ø —á–∞—Ç-–±–æ—Ç, —Å–æ–∑–¥–∞–Ω–Ω—ã–π –¥–ª—è –æ–±—â–µ–Ω–∏—è –∏ –ø–æ–º–æ—â–∏. –î–∞–≤–∞–π—Ç–µ –ø–æ–∑–Ω–∞–∫–æ–º–∏–º—Å—è!',
      '–Ø –≤–∞—à –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫. –ú–æ–≥—É –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä –∏ –ø–æ–º–æ—á—å –≤–∞–º!']),
    
    (r'—à—É—Ç–∫–∏|–∞–Ω–µ–∫–¥–æ—Ç|—Ä–∞—Å—Å–∫–∞–∂–∏ —à—É—Ç–∫—É',
     ['–ó–Ω–∞–µ—Ç–µ, –ø–æ—á–µ–º—É –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç—ã –Ω–µ –ª—é–±—è—Ç –ø—Ä–∏—Ä–æ–¥—É? –¢–∞–º —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –±–∞–≥–æ–≤! üòÑ',
      '–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π —Å–∏–¥–∏—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ? –ö–æ—Ç-–∞–¥–º–∏–Ω! üò∫', ]),
    
    (r'.*',
     ['–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ... –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ!', '–ü–æ–Ω—è—Ç–Ω–æ... –ê —á—Ç–æ –≤—ã –æ–± —ç—Ç–æ–º –¥—É–º–∞–µ—Ç–µ?', '–•–º, –ª—é–±–æ–ø—ã—Ç–Ω–æ! –î–∞–≤–∞–π—Ç–µ –æ–±—Å—É–¥–∏–º —ç—Ç–æ –ø–æ–¥—Ä–æ–±–Ω–µ–µ.'])
]

# –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ —á–∞—Ç-–±–æ—Ç–∞
chatbot = Chat(patterns, reflections)

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start - –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"""
    await update.message.reply_text(
        '–ü—Ä–∏–≤–µ—Ç! –Ø –ø—Ä–æ—Å—Ç–æ–π —á–∞—Ç-–±–æ—Ç. –î–∞–≤–∞–π –ø–æ–æ–±—â–∞–µ–º—Å—è!'
    )

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help - –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–ø—Ä–∞–≤–∫—É –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –±–æ—Ç–∞"""
    await update.message.reply_text(
        '–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ –º–Ω–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∏ —è –ø–æ—Å—Ç–∞—Ä–∞—é—Å—å –æ—Ç–≤–µ—Ç–∏—Ç—å!'
    )

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π - –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —à–∞–±–ª–æ–Ω–æ–≤"""
    user_message = update.message.text.lower()
    response = chatbot.respond(user_message)
    await update.message.reply_text(response)

def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞"""
    # –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ –ø–µ—Ä–µ–¥–∞—á–∞ —Ç–æ–∫–µ–Ω–∞ –±–æ—Ç–∞
    application = (
        Application.builder()
        .token(os.getenv('TELEGRAM_BOT_TOKEN'))
        .build()
    )
    
    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∫–æ–º–∞–Ω–¥ –∏ —Å–æ–æ–±—â–µ–Ω–∏–π
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("help", help_command))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))

    # –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
    application.run_polling(allowed_updates=Update.ALL_TYPES)

if __name__ == '__main__':
    main() 